// Segment.io (c) 2012
// Feedback very welcome at friends@segment.io
(function(e){var t=Object.prototype,n=window,r=document,i=navigator,s={ready:!1,callbacks:[],markReady:function(){s.ready=!0;var e=s.callbacks.pop();while(e)e(),e=s.callbacks.pop()},check:function(){return r.readyState=="complete"||r.addEventListener&&r.readyState=="loaded"?(s.markReady(),!0):!1},listen:function(){this.check()||(r.addEventListener?(r.addEventListener("DOMContentLoaded",this.markReady,!0),r.addEventListener("readystatechange",this.check,!0),n.addEventListener("load",this.markReady,!0)):r.attachEvent&&(r.attachEvent("onreadystatechange",this.check),n.attachEvent("onload",this.markReady)))},wait:function(e){this.ready?e():this.callbacks.push(e)}};s.listen();var o={keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="",n,r,i,s,u,a,f,l=0;e=o.utf8_encode(e);while(l<e.length)n=e.charCodeAt(l++),r=e.charCodeAt(l++),i=e.charCodeAt(l++),s=n>>2,u=(n&3)<<4|r>>4,a=(r&15)<<2|i>>6,f=i&63,isNaN(r)?a=f=64:isNaN(i)&&(f=64),t=t+this.keyStr.charAt(s)+this.keyStr.charAt(u)+this.keyStr.charAt(a)+this.keyStr.charAt(f);return t},utf8_encode:function(e){var t=String.fromCharCode;e=e.replace(/\r\n/g,"\n");var n="";for(var r=0;r<e.length;r++){var i=e.charCodeAt(r);i<128?n+=t(i):i>127&&i<2048?(n+=t(i>>6|192),n+=t(i&63|128)):(n+=t(i>>12|224),n+=t(i>>6&63|128),n+=t(i&63|128))}return n}},u=function(e){var n=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,r=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,i,s,o={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},u,a=function(e){return r.lastIndex=0,r.test(e)?'"'+e.replace(r,function(e){var t=o[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'},f=function(e,n){var r,o,l,h,d=i,v,m=n[e];m&&typeof m=="object"&&typeof m.toJSON=="function"&&(m=m.toJSON(e)),m&&c.isDate(m)&&(m=p(m)),typeof u=="function"&&(m=u.call(n,e,m));switch(typeof m){case"string":return a(m);case"number":return isFinite(m)?String(m):"null";case"boolean":case"null":return String(m);case"object":if(!m)return"null";i+=s,v=[];if(t.toString.apply(m)==="[object Array]"){h=m.length;for(r=0;r<h;r+=1)v[r]=f(r,m)||"null";return l=v.length===0?"[]":i?"[\n"+i+v.join(",\n"+i)+"\n"+d+"]":"["+v.join(",")+"]",i=d,l}if(u&&typeof u=="object"){h=u.length;for(r=0;r<h;r+=1)typeof u[r]=="string"&&(o=u[r],l=f(o,m),l&&v.push(a(o)+(i?": ":":")+l))}else for(o in m)t.hasOwnProperty.call(m,o)&&(l=f(o,m),l&&v.push(a(o)+(i?": ":":")+l));return l=v.length===0?"{}":i?"{\n"+i+v.join(",\n"+i)+"\n"+d+"}":"{"+v.join(",")+"}",i=d,l}};return f("",{"":e})},a={get:function(e){var t=0;document.cookie.match("^"+e+"=")||(t=document.cookie.indexOf("; "+e+"="),t!==-1&&(t+=2));if(t!==-1){var n=document.cookie.indexOf(";",t);return n===-1&&(n=document.cookie.length),unescape(document.cookie.substring(t+e.length+1,n))}return""},set:function(e,t,n,r,i,s){t=t.toString();var o=[escape(e),"=",escape(t)];if(n){var u=new Date;u.setDate(u.getDate()+n),o.push("; expires=",u.toGMTString())}r&&o.push("; domain=",r),i&&o.push("; path=",i),s&&o.push("; secure"),document.cookie=o.join("")}},f=t.toString,l=Array.prototype.slice,c={clone:function(e){if(!e)return;return this.extend({},e)},extend:function(e){if(!this.isObject(e))return;var t=Array.prototype.slice.call(arguments,1);for(var n=0,r;r=t[n];n++){if(!this.isObject(r))continue;for(var i in r)e[i]=r[i]}return e},clean:function(e){var t=0;for(var n in e)e[n]?t+=1:delete e[n];return t},keys:Object.keys||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var n=[];for(var r in e)t.hasOwnProperty.call(e,r)&&(n[n.length]=r);return n},isObject:function(e){return e===Object(e)},isString:function(e){return f.call(e)=="[object String]"},isNumber:function(e){return f.call(e)=="[object Number]"},isFunction:function(e){return f.call(e)=="[object Function]"},isNaN:function(e){return e!==e},isBoolean:function(e){return e===!0||e===!1||f.call(e)=="[object Boolean]"},isDate:function(e){return f.call(e)=="[object Date]"},isArray:Array.isArray||function(e){return f.call(e)=="[object Array]"},isDefined:function(e){return e!==void 0},isValidPrimitiveValue:function(e){return this.isString(e)||this.isNumber(e)&&!this.isNaN(e)||this.isBoolean(e)||this.isDate(e)},isEmail:function(e){return this.isString(e)&&/\S+@\S+\.\S{2,4}/.test(e)},now:function(){return(new Date).getTime()}},h={create:function(){var e=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return e()+e()+e()+e()}},p=function(e){function t(e,t){e=e.toString(),t=t||2;while(e.length<t)e="0"+e;return e}var n=e.getUTCFullYear(),r=t(e.getUTCMonth()+1),i=t(e.getUTCDate()),s=t(e.getUTCHours()),o=t(e.getUTCMinutes()),u=t(e.getUTCSeconds()),a=t(e.getUTCMilliseconds(),3);return n+"-"+r+"-"+i+"T"+s+":"+o+":"+u+"."+a+"Z"},d={detect:function(){var e={},t=document.location.search.substring(1);t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].split("=");e[r[0].toLowerCase()]=r[1]}return e}},v={log:function(e,t){t="[segmentio] "+t,e&&typeof console!="undefined"&&console&&console.log?console.log(t):typeof console!="undefined"&&console&&console.warn&&console.warn(t)}},m={providers:[v],level:3,toOrdinal:function(e){return e==="verbose"?0:e==="error"?1:2},addLogger:function(e){this.providers.push(e)},setLevel:function(e){this.level=this.toOrdinal(e)},log:function(e,t,n,r){var i=this.toOrdinal(e);if(i>=this.level){r&&(n="["+r+"] "+n);for(var s=0;s<this.providers.length;s+=1)this.providers[s].log(t,n)}}},g={name:"jsonp",enabled:!0,scriptTags:{},callbacks:{},supported:function(){return!0},removeScriptTag:function(e){e in this.scriptTags&&(this.scriptTags[e].parentNode.removeChild(this.scriptTags[e]),this.scriptTags[e]=null,delete this.scriptTags[e])},callback:function(e,t){this.removeScriptTag(e);if(e in this.callbacks){var n=this.callbacks[e];return delete this.callbacks[e],n(t.success,t)}},send:function(e,t,n){t.callback="segment.callback",this.callbacks[t.callbackId.toString()]=n;var r=u(t);if(r.length>1500)return m.log("error",!1,"Supplied data exceeds maximum size (1500 JSON characters).",t.callbackId),n(!1,{code:"CHAR_LIMIT_EXCEEDED",message:"Exceeded limit of 1500 JSON characters per request."});var i=o.encode(r);i=encodeURIComponent(i),e+="?data="+i;var s=document.createElement("script");s.type="text/javascript",s.async=!0,s.defer=!0,s.src=e;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(s,a)}},y={name:"cors",enabled:!0,supported:function(){if("XMLHttpRequest"in window){var e=new XMLHttpRequest;return"withCredentials"in e?!0:!1}return!1},send:function(e,t,n){var r=this,i=u(t);if(i.length>1500)return m.log("error",!1,"Supplied data exceeds maximum size (1500 JSON characters).",t.callbackId),n(!1,{code:"CHAR_LIMIT_EXCEEDED",message:"Exceeded limit of 1500 JSON characters per request."});var s=new XMLHttpRequest;s.onload=function(e){if(e&&e.target&&e.target.responseText){var t=e.target.status===200;t||(r.enabled=!1,b.init());if(JSON&&JSON.parse)try{var i=JSON.parse(e.target.responseText);n(t,i)}catch(s){m.log("error",!1,"Failed to parse API response as json : "+e.target.responseText),n(!1,s)}else n(t,{})}else n(!1,e)},s.open("POST",e,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(i)}},b={providers:[y,g],selected:null,init:function(){for(var e=0;e<this.providers.length;e+=1)if(this.providers[e].supported()&&this.providers[e].enabled)return this.selected=this.providers[e],m.log("verbose",!0,"Selected "+this.selected.name+" as API transport."),!0;return!1},send:function(e,t,n){return this.selected.send(e,t,n)}};b.init();var w={name:"utm",get:function(){var e=d.detect(),t={source:e.utm_source,medium:e.utm_medium,term:e.utm_term,content:e.utm_content,campaign:e.utm_campaign},n=c.clean(t);return n>0?t:null}},E={enabled:!1,config:{baseUrl:("https:"===document.location.protocol?"https://":"http://")+"api2.segment.io",apiVersion:"v1",apiKey:null,loadedPageEventName:"Loaded a Page",cookie:{delimiter:"----",key:"_sio",duration:730,secure:!1,path:"/"}},user:{id:null,session:null},stats:{requests:0,successful:0,failed:0,identifies:0,tracks:0,aliases:0},visitSources:[],visitContext:null,pageSources:[w],pageContext:null,isEnabled:function(){var e=navigator.userAgent,t=/(google web preview|googlebot)/i.test(e)||/yahoo/i.test(e)||/bingbot/i.test(e);return!t},initialize:function(e,t){c.isObject(t)||(t={verbose:!1});if(!c.isString(e)||e.length===0)return m.log("error",!1,"Please call initialize with a valid apiKey string as the first argument.");this.config.apiKey=e,t.verbose&&m.setLevel("verbose"),this.readCookie(),this.enabled=this.isEnabled();if(this.enabled){this.buildContexts();if(!this.user.session||this.user.session==="")this.user.session=h.create(),this.writeCookie();this.track(this.config.loadedPageEventName,this.pageContext)}},readCookie:function(){var e=a.get(this.config.cookie.key);if(e){var t=e.split(this.config.cookie.delimiter);t.length>=1&&t[0]!==""&&(this.user.session=t[0]),t.length>=2&&t[1]!==""&&(this.user.id=t[1])}},writeCookie:function(){var e=[this.user.session,this.user.id].join(this.config.cookie.delimiter);this.setCookie(this.config.cookie.key,e)},setCookie:function(e,t){var n=this.config;a.set(e,t,n.cookie.duration,this.cookieDomain(),n.cookie.path,n.cookie.secure)},cookieDomain:function(){var e=window.location.hostname,t=e.match(/[a-z0-9][a-z0-9\-]*[a-z0-9]\.[a-z\.]{2,6}$/i);if(e==="localhost")return null;var n=t?t[0]:e;return"."+n},identify:function(t,n,r,i){if(t===e||c.isFunction(t))return m.log("error",!1,"Identify must be called with either userId or {traits}.");c.isFunction(r)&&(i=r,r=e),c.isFunction(n)&&(i=n,n=e);var s=!1;c.isObject(t)&&(n=t,t=this.user.id),c.isNumber(t)&&(t=t.toString());if(!c.isString(t)&&t!==null&&t!==e)return m.log("error",!1,"Identify requires the userId to be either a string or a number.");this.user.id!==t&&(s=!0,c.isEmail(t)||m.log("verbose",!0,"This userId: "+t+" doesnt appear to be an email - we recommend"+" using an email :)"),this.user.id&&(this.user.session=h.create()),this.user.id=t,this.writeCookie()),n=n||{};if(!c.isObject(n)||c.isArray(n)||c.isDate(n))return m.log("error",!1,"Identify {traits} (second argument) must be a javascript object.");c.keys(n).length>0&&(s=!0),s?this.enabled?(n=this.cleanProperties(n),m.log("verbose",!1,["Identifying user:",this.user.id?this.user.id:"anonymous","traits:",u(n)].join(" ")),this.request("/i",{sessionId:this.user.session,userId:this.user.id,traits:n,context:c.extend({},r,this.visitContext)},i),this.stats.identifies+=1):m.log("error",!1,"The segmentio client is not initialized. Either segment.initialize wasnt called, or this is a search spider."):c.isFunction(i)&&i(!0)},buildContexts:function(){this.visitContext=this.buildVisitContext(),this.pageContext=this.buildPageViewProperties()},buildVisitContext:function(){var e={language:i.language,library:"segment.js"};return this.buildContext(e,this.visitSources),e},buildPageViewProperties:function(){var e={url:r.location.href,referrer:r.referrer,userAgent:i.userAgent};return this.buildContext(e,this.pageSources),e},buildContext:function(e,t){for(var n=0;n<t.length;n+=1)if(t[n].get&&c.isString(t[n].name)){var r=t[n].get();r&&(e[t[n].name]=r)}},track:function(t,n,r,i){c.isFunction(r)&&(i=r,r=e),c.isFunction(n)&&(i=n,n=e);if(!c.isString(t)){var s="Track must be called with an event name (string as the first argument).";m.log("error",!1,s),c.isFunction(i)&&i(!1,{message:s});return}n=n||{},c.isObject(n)?this.enabled?(n=this.cleanProperties(n),m.log("verbose",!0,["Beginning track:",t,"user:",this.user.id?this.user.id:"anonymous","properties:",u(n)].join(" ")),this.request("/t",{userId:this.user.id,sessionId:this.user.session,event:t,properties:n,context:c.extend({},r,this.visitContext)},i),this.stats.tracks+=1):m.log("error",!1,"The segmentio client is not initialized. Either segment.initialize wasnt called, or this is a search spider."):m.log("error",!1,"Track {properties} (second argument) must be a javascript object.")},alias:function(t,n,r,i){c.isFunction(n)&&(i=n,n=e,r=e),c.isFunction(r)&&(i=r,r=e),c.isObject(n)&&(r=n,n=null),!c.isString(t)&&c.isString(n)&&(t=this.user.id||this.user.session),c.isString(t)&&!c.isString(n)&&(n=t,t=this.user.id||this.user.session);if(!c.isString(t)){var s="Alias must be called with a from id(string as the first argument).";m.log("error",!1,s),c.isFunction(i)&&i(!1,{message:s});return}if(!c.isString(n)){var o="Alias must be called with a to id(string as the first argument).";m.log("error",!1,o),c.isFunction(i)&&i(!1,{message:o});return}this.enabled?(m.log("verbose",!0,["Beginning alias:","from:",t,"to:",n].join(" ")),this.request("/a",{from:t,to:n,context:c.extend({},r,this.visitContext)},i),this.stats.aliases+=1):m.log("error",!1,"The segment.io client is not initialized. Either segment.initialize wasnt called, or this is a search spider.")},request:function(e,t,n){var r=this,i=this.config.baseUrl+"/"+this.config.apiVersion+e;this.fillCommonPayload(t,n),m.log("verbose",!0,[e,"started",u(t)].join(" "),t.callbackId),b.send(i,t,function(e,i){if(e)m.log("verbose",e,"Segment.io API call succeeded.",i.callbackId),r.stats.successful+=1;else{var s="CONNECT_ERR",o="Failed to connect to API endpoint.";i&&i.error&&(i.error.type&&(s=i.error.type),i.error.message&&(o=i.error.message));var u="Segment.io API call failed; code: "+s+" message: "+o;r.stats.failed+=1,m.log("error",e,u,t.callbackId)}n&&n(e,i)}),this.stats.requests+=1},cleanProperties:function(e,t){if(!t)t=0;else if(t>5)return m.log("error",!1,"Invalid property because it has nested objects more than 4 levels deep."),{};var n={},r=c.keys(e);for(var i=0;i<r.length;i+=1){var s=r[i],o=e[s];if(o===window)m.log("error",!1,'Woah! You can not pass in the "window" object into segmentio API calls.');else if(!c.isDate(o)&&!c.isArray(o)&&c.isObject(o)){var u=this.cleanProperties(o,t+1);c.keys(u).length>0&&(n[s]=u)}else c.isArray(o)?m.log("error",!1,"Property "+s+" is invalid because it is an array"):c.isValidPrimitiveValue(o)?n[s]=o:m.log("error",!1,"Property "+s+" is an invalid type")}return n},fillCommonPayload:function(e,t){e.apiKey=this.config.apiKey,e.callbackId=Math.floor(Math.random()*1e3)}},S={initialize:function(e,t){return E.initialize(e,t)},identify:function(e,t,n,r){return E.identify(e,t,n,r)},alias:function(e,t,n,r){return E.alias(e,t,n,r)},track:function(e,t,n,r){return E.track(e,t,n,r)},callback:function(e){b.selected.name==="jsonp"&&e.callbackId&&g.callback(e.callbackId,e)},logLevel:function(e){m.setLevel(e)},verbose:function(e){e?m.setLevel("verbose"):m.setLevel("silent")},addLogger:function(e){e&&e.log&&m.addLogger(e)},baseUrl:function(e){E.config.baseUrl=e},client:function(e){e(E)}};S.init=S.initialize;var x=function(e){if(e&&e.length)for(var t=0;t<e.length;t+=1)this.push(e[t])},T=function(e){return function(){this.push([e].concat(Array.prototype.slice.call(arguments,0)))}},N=c.keys(S);for(var C=0;C<N.length;C+=1)x.prototype[N[C]]=T(N[C]);x.prototype.init=x.prototype.initialize,x.prototype.push=function(e){if(e)if(c.isArray(e)){var t=e.splice(0,1);S[t]?setTimeout(function(){try{S[t].apply(S,e)}catch(n){m.log("error",!1,"Internal error: "+n.stack)}},1):m.log("error",!1,t+" is not a valid segment.io action.")}else c.isFunction(e)&&e()},s.wait(function(){window.seg?setTimeout(function(){window.segment=window.seg=new x(window.seg)},100):window.segment&&setTimeout(function(){window.segment=new x(window.segment)},100)})})();